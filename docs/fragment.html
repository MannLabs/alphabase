---

title: Peptide fragment functionalities


keywords: fastai
sidebar: home_sidebar



nb_path: "nbdev_nbs/peptide/fragment.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbdev_nbs/peptide/fragment.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="First,-it-is-worth-mentioning-that,-in-AlphaBase:">First, it is worth mentioning that, in AlphaBase:<a class="anchor-link" href="#First,-it-is-worth-mentioning-that,-in-AlphaBase:"> </a></h3><ol>
<li>peptide N-term modification site is 0</li>
<li>C-term modification site is -1 </li>
<li>other modifications sites are integers from 1 to nAA</li>
</ol>
<p>Just in case that we have two modifications, one is on the peptide N-term, and the other is on the N-term AA site chain. Similar for C-term sites.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_charged_frag_types" class="doc_header"><code>get_charged_frag_types</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L31" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_charged_frag_types</code>(<strong><code>frag_types</code></strong>:<code>List</code>[<code>str</code>], <strong><code>max_frag_charge</code></strong>:<code>int</code>=<em><code>2</code></em>)</p>
</blockquote>
<p>Combine fragment types and charge states.</p>
<p>Args:
    frag_types (List[str]): e.g. ['b','y','b_modloss','y_modloss']
    max_frag_charge (int): max fragment charge. (default: 2)</p>
<p>Returns:
    List[str]: charged fragment types</p>
<p>Examples::</p>

<pre><code>&gt;&gt;&gt; frag_types=['b','y','b_modloss','y_modloss']
&gt;&gt;&gt; get_charged_frag_types(frag_types, 2)
['b_z1','b_z2','y_z1','y_z2','b_modloss_z1','b_modloss_z2','y_modloss_z1','y_modloss_z2']</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="parse_charged_frag_type" class="doc_header"><code>parse_charged_frag_type</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L57" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parse_charged_frag_type</code>(<strong><code>charged_frag_type</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Oppsite to <a href="/alphabase/fragment.html#get_charged_frag_types"><code>get_charged_frag_types</code></a>.</p>
<p>Args:
    charged_frag_type (str): e.g. 'y_z1', 'b_modloss_z1'</p>
<p>Returns:
    str: fragment type, e.g. 'b','y'
    int: charge state</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_charged_frag_types</span><span class="p">([</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;b_modloss&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;b_z1&#39;</span><span class="p">,</span> <span class="s1">&#39;b_z2&#39;</span><span class="p">,</span> <span class="s1">&#39;b_modloss_z1&#39;</span><span class="p">,</span> <span class="s1">&#39;b_modloss_z2&#39;</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">parse_charged_frag_type</span><span class="p">(</span><span class="s1">&#39;b_z2&#39;</span><span class="p">)</span><span class="o">==</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">parse_charged_frag_type</span><span class="p">(</span><span class="s1">&#39;b_modloss_z2&#39;</span><span class="p">)</span><span class="o">==</span><span class="p">(</span><span class="s1">&#39;b_modloss&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Fragment-dataframe-processing">Fragment dataframe processing<a class="anchor-link" href="#Fragment-dataframe-processing"> </a></h1><p>In AlphaX Ecosystem, library fragments are stored in a dataframe, where the columns are charged_frag_types (<code>['b_z1','b_z2','y_z1','y_z2','b_modloss_z1','y_H2O_z1'...]</code>) and the rows are corresponding positions (starting with peptide N-term) of the fragments. Library precursor/peptide dataframe must contain <code>frag_start_idx</code> and <code>frag_end_idx</code> columns to tell us where are the fragments of each precursor/peptide.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We provide different ways to initialize fragment dataframes, see below:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="init_zero_fragment_dataframe" class="doc_header"><code>init_zero_fragment_dataframe</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L76" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>init_zero_fragment_dataframe</code>(<strong><code>peplen_array</code></strong>:<code>array</code>, <strong><code>charged_frag_types</code></strong>:<code>List</code>[<code>str</code>], <strong><code>dtype</code></strong>=<em><code>float64</code></em>)</p>
</blockquote>
<p>Initialize a zero dataframe based on peptide length
(nAA) array (peplen_array) and charge_frag_types (column number).
The row number of returned dataframe is np.sum(peplen_array-1).</p>
<p>Args:
    peplen_array (np.array): peptide lengths for the fragment dataframe
    charged_frag_types (List[str]):
        <code>['b_z1','b_z2','y_z1','y_z2','b_modloss_z1','y_H2O_z1'...]</code></p>
<p>Returns:
    pd.DataFrame: <code>fragment_df</code> with zero values
    np.array (int64): the start indices point to the <code>fragment_df</code> for each peptide
    np.array (int64): the end indices point to the <code>fragment_df</code> for each peptide</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="init_fragment_dataframe_from_other" class="doc_header"><code>init_fragment_dataframe_from_other</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L104" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>init_fragment_dataframe_from_other</code>(<strong><code>reference_fragment_df</code></strong>:<code>DataFrame</code>, <strong><code>dtype</code></strong>=<em><code>float64</code></em>)</p>
</blockquote>
<p>Init zero fragment dataframe from the <code>reference_fragment_df</code> (same rows and same columns)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="init_fragment_by_precursor_dataframe" class="doc_header"><code>init_fragment_by_precursor_dataframe</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L116" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>init_fragment_by_precursor_dataframe</code>(<strong><code>precursor_df</code></strong>, <strong><code>charged_frag_types</code></strong>:<code>List</code>[<code>str</code>], <strong><code>reference_fragment_df</code></strong>:<code>DataFrame</code>=<em><code>None</code></em>, <strong><code>dtype</code></strong>=<em><code>float64</code></em>, <strong><code>inplace_in_reference</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Init zero fragment dataframe for the <code>precursor_df</code>. If
the <code>reference_fragment_df</code> is provided, it will generate
the dataframe based on the reference. Otherwise it
generates the dataframe from scratch.</p>
<p>Args:
    precursor_df (pd.DataFrame): precursors to generate fragment masses,
        if <code>precursor_df</code> contains the 'frag_start_idx' column,
        it is better to provide <code>reference_fragment_df</code> as
        <code>precursor_df.frag_start_idx</code> and <code>precursor.frag_end_idx</code>
        point to the indices in <code>reference_fragment_df</code>
    charged_frag_types (List):
        <code>['b_z1','b_z2','y_z1','y_z2','b_modloss_z1','y_H2O_z1'...]</code>
    reference_fragment_df (pd.DataFrame): init zero fragment_mz_df based
        on this reference. If None, fragment_mz_df will be
        initialized by :func:<code>alphabase.peptide.fragment.init_zero_fragment_dataframe</code>.
        Defaults to None.
    inplace_in_reference (bool, optional): if calculate the fragment mz
    inplace in the reference_fragment_df (default: False)</p>
<p>Returns:
    pd.DataFrame: zero <code>fragment_df</code> with given <code>charged_frag_types</code> columns</p>
<p>Raises:
    ValueError: if <code>reference_fragment_df</code> is None but there are 'frag_start_idx'
        in the <code>precursor_df</code>, meaning that there are some other fragment
        dataframes linked to the <code>precursor_df</code>, these fragment dataframes must
        be provided as <code>reference_fragment_df</code>.
        If we are sure that other fragment dataframes are not needed any more,
        we can just <code>del precursor_df['frag_start_idx']</code> before call this function.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For a subset of the precursor dataframe, we need to set or get fragment values for the slicing (by <code>frag_start_idx</code> and <code>frag_end_idx</code>in <code>precursor_df</code>) of the fragment dataframe. We use <code>update_sliced_fragment_dataframe()</code> to set the values, and <code>get_sliced_fragment_dataframe()</code> to get values.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="update_sliced_fragment_dataframe" class="doc_header"><code>update_sliced_fragment_dataframe</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L193" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>update_sliced_fragment_dataframe</code>(<strong><code>fragment_df</code></strong>:<code>DataFrame</code>, <strong><code>values</code></strong>:<code>array</code>, <strong><code>frag_start_end_list</code></strong>:<code>List</code>[<code>Tuple</code>[<code>int</code>, <code>int</code>]], <strong><code>charged_frag_types</code></strong>:<code>List</code>[<code>str</code>]=<em><code>None</code></em>)</p>
</blockquote>
<p>Set the values of the slices <code>frag_start_end_list=[(start,end),(start,end),...]</code>
of fragment_df.</p>
<p>Args:
    fragment_df (pd.DataFrame): fragment dataframe to set the values
    frag_start_end_list (List[Tuple[int,int]]): e.g. <code>[(start,end),(start,end),...]</code>
    charged_frag_types (List[str], optional): e.g. <code>['b_z1','b_z2','y_z1','y_z2']</code>.
        If None, the columns of values should be the same as fragment_df's columns.
        It is much faster if charged_frag_types is None as we use numpy slicing,
        otherwise we use pd.loc (much slower).
        Defaults to None.</p>
<p>Returns:
    pd.DataFrame: fragment_df after the values are set into slices</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_sliced_fragment_dataframe" class="doc_header"><code>get_sliced_fragment_dataframe</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L224" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_sliced_fragment_dataframe</code>(<strong><code>fragment_df</code></strong>:<code>DataFrame</code>, <strong><code>frag_start_end_list</code></strong>:<code>Union</code>[<code>List</code>[<code>T</code>], <code>array</code>], <strong><code>charged_frag_types</code></strong>:<code>List</code>[<code>T</code>]=<em><code>None</code></em>)</p>
</blockquote>
<p>Get the sliced fragment_df from <code>frag_start_end_list=[(start,end),(start,end),...]</code>.</p>
<p>Args:
    fragment_df (pd.DataFrame): fragment dataframe to get values
    frag_start_end_list (List[Tuple[int,int]]): e.g. <code>[(start,end),(start,end),...]</code>
    charged_frag_types (List[str]): e.g. <code>['b_z1','b_z2','y_z1','y_z2']</code>.
        if None, all columns will be considered</p>
<p>Returns:
    pd.DataFrame: sliced fragment_df. If <code>charged_frag_types</code> is None,
    return fragment_df with all columns</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For some search engines, it reports different result files for different raw files. After load them separately, we concatenate <code>precursor_df_list</code> and <code>fragment_df_list</code> into single dataframes respectively. The main processing here is to cumulate <code>frag_start_idx</code> and <code>frag_end_idx</code> for different <code>precursor_df</code>s.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="concat_precursor_fragment_dataframes" class="doc_header"><code>concat_precursor_fragment_dataframes</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L251" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>concat_precursor_fragment_dataframes</code>(<strong><code>precursor_df_list</code></strong>:<code>List</code>[<code>DataFrame</code>], <strong><code>fragment_df_list</code></strong>:<code>List</code>[<code>DataFrame</code>], <strong>*<code>other_fragment_df_lists</code></strong>)</p>
</blockquote>
<p>Since fragment_df is indexed by precursor_df, when we concatenate multiple
fragment_df, the indexed positions will change for in precursor_dfs,
this function keeps the correct indexed positions of precursor_df when
concatenating multiple fragment_df dataframes.</p>
<p>Args:
    precursor_df_list (List[pd.DataFrame]): precursor dataframe list to concatenate
    fragment_df_list (List[pd.DataFrame]): fragment dataframe list to concatenate
    *other_fragment_df_lists: arbitray other fragment dataframe list to concatenate,
        e.g. fragment_mass_df, fragment_inten_df, ...</p>
<p>Returns:
    Tuple[pd.DataFrame,...]: concatenated precursor_df, fragment_df, *other_fragment_df ...</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="calc_fragment_mz_values_for_same_nAA" class="doc_header"><code>calc_fragment_mz_values_for_same_nAA</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L285" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>calc_fragment_mz_values_for_same_nAA</code>(<strong><code>df_group</code></strong>:<code>DataFrame</code>, <strong><code>nAA</code></strong>:<code>int</code>, <strong><code>charged_frag_types</code></strong>:<code>list</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="mask_fragments_for_charge_greater_than_precursor_charge" class="doc_header"><code>mask_fragments_for_charge_greater_than_precursor_charge</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L382" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>mask_fragments_for_charge_greater_than_precursor_charge</code>(<strong><code>fragment_df</code></strong>:<code>DataFrame</code>, <strong><code>precursor_charge_array</code></strong>:<code>array</code>, <strong><code>nAA_array</code></strong>:<code>array</code>, <strong><code>mask_fragment_charges</code></strong>=<em><code>[2, 3]</code></em>)</p>
</blockquote>
<p>Mask the fragment dataframe when
the fragment charge is larger than the precursor charge</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Create-fragment-mz-dataframe">Create fragment mz dataframe<a class="anchor-link" href="#Create-fragment-mz-dataframe"> </a></h1><p>This is one of the most important functions in alphabase. For a given <code>precursor_df</code>, it calculates the fragment ion dataframe, and also set the <code>frag_start_idx</code> and <code>frag_end_idx</code> column values to connect the <code>precursor_df</code> and <code>fragment_mz_df</code>.</p>
<p>When creating a new fragment mz/intensity dataframes for a precursor, alphabase will check if <code>frag_start_idx</code> exists. As the <code>frag_start_idx</code> points to an existing fragment dataframe (refers to <code>reference_frag_df</code>), so we have to provide the <code>reference_frag_df</code> to make sure that <code>reference_frag_df</code> and newly created fragment_df are consisitent.</p>
<p>For the more convenient and faster calculation, we should do as follows:</p>
<ol>
<li>Sort <code>precursor_df</code> by 'nAA' (<code>precursor_df.sort_values('nAA', inplace=True)</code>) to make sure groupby('nAA') will not change the order of the <code>precursor_df</code>.</li>
<li>Reset index (<code>precursor_df.reset_index(drop=True, inplace=True)</code>) to make sure iloc and loc will index the same dataframe subset.</li>
<li>Delete <code>frag_start_idx</code> and <code>frag_end_idx</code> columns if they exist (otherwise alphabase will raise ValueError).</li>
<li>Call <code>create_fragment_mz_dataframe_by_sort_nAA(precursor_df, charged_frag_types)</code> or <code>create_fragment_mz_dataframe(precursor_df, charged_frag_types)</code>. <a href="/alphabase/fragment.html#create_fragment_mz_dataframe"><code>create_fragment_mz_dataframe</code></a> will also call <code>create_fragment_mz_dataframe_by_sort_nAA</code> if there is no <code>frag_start_idx</code> column.</li>
<li>If we need to predict/calculate <code>fragment_intensity_df</code>, we can redo step 3 (delete frag idxes columns) and then call 'intensity prediction' or 'intensity calculation'.</li>
</ol>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_fragment_mz_dataframe_by_sort_precursor" class="doc_header"><code>create_fragment_mz_dataframe_by_sort_precursor</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L402" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_fragment_mz_dataframe_by_sort_precursor</code>(<strong><code>precursor_df</code></strong>:<code>DataFrame</code>, <strong><code>charged_frag_types</code></strong>:<code>List</code>[<code>T</code>], <strong><code>batch_size</code></strong>=<em><code>500000</code></em>)</p>
</blockquote>
<p>Sort nAA in precursor_df for faster fragment mz dataframe creation.</p>
<p>Because the fragment mz values are continous in memory, so it is faster
when setting values in pandas.</p>
<p>Note that this function will change the order and index of precursor_df</p>
<p>Args:
    precursor_df (pd.DataFrame): precursor dataframe
    charged_frag_types (List): fragment types list
    batch_size (int, optional): Calculate fragment mz values in batch.
        Defaults to 500000.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_fragment_mz_dataframe" class="doc_header"><code>create_fragment_mz_dataframe</code><a href="https://github.com/MannLabs/alphabase/tree/main/alphabase/peptide/fragment.py#L457" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_fragment_mz_dataframe</code>(<strong><code>precursor_df</code></strong>:<code>DataFrame</code>, <strong><code>charged_frag_types</code></strong>:<code>List</code>[<code>T</code>], <strong><code>reference_fragment_df</code></strong>:<code>DataFrame</code>=<em><code>None</code></em>, <strong><code>inplace_in_reference</code></strong>=<em><code>False</code></em>, <strong><code>batch_size</code></strong>=<em><code>500000</code></em>)</p>
</blockquote>
<p>Generate fragment mass dataframe for the precursor_df. If
the <code>reference_fragment_df</code> is provided and precursor_df contains <code>frag_start_idx</code>,
it will generate  the mz dataframe based on the reference. Otherwise it
generates the mz dataframe from scratch.</p>
<p>Args:
    precursor_df (pd.DataFrame): precursors to generate fragment masses,
        if <code>precursor_df</code> contains the 'frag_start_idx' column,
        <code>reference_fragment_df</code> must be provided
    charged_frag_types (List):
        <code>['b_z1','b_z2','y_z1','y_z2','b_modloss_1','y_H2O_z1'...]</code>
    reference_fragment_df (pd.DataFrame): generate fragment_mz_df based
        on this reference, as <code>precursor_df.frag_start_idx</code> and
        <code>precursor.frag_end_idx</code> point to the indices in
        <code>reference_fragment_df</code></p>
<p>Returns:
    pd.DataFrame: <code>fragment_mz_df</code> with given <code>charged_frag_types</code></p>
<p>Raises:
    ValueError: when <code>precursor_df</code> contains 'frag_start_idx' but
    <code>reference_fragment_df</code> is not None</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Examples-and-unittests:">Examples and unittests:<a class="anchor-link" href="#Examples-and-unittests:"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test <code>create_fragment_mz_dataframe_by_sort_nAA</code></p>
<p><code>create_fragment_mz_dataframe_by_sort_nAA</code> will sort <code>nAA</code> columns in <code>precursor_df</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">repeat</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">peptides</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AGHCEWQMKAADER&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">mods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Acetyl@Protein N-term;Carbamidomethyl@C;Oxidation@M&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0;4;8&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">peptides</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;AGHCEWQMK&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">mods</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">sites</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>

<span class="n">precursor_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">peptides</span><span class="p">,</span>
    <span class="s1">&#39;mods&#39;</span><span class="p">:</span> <span class="n">mods</span><span class="p">,</span>
    <span class="s1">&#39;mod_sites&#39;</span><span class="p">:</span> <span class="n">sites</span>
<span class="p">})</span>
<span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;nAA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
<span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">precursor_df</span> <span class="o">=</span> <span class="n">update_precursor_mz</span><span class="p">(</span><span class="n">precursor_df</span><span class="p">)</span>

<span class="n">fragment_mz_df</span> <span class="o">=</span> <span class="n">create_fragment_mz_dataframe_by_sort_precursor</span><span class="p">(</span>
    <span class="n">precursor_df</span><span class="p">,</span>
    <span class="n">get_charged_frag_types</span><span class="p">([</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;b_modloss&#39;</span><span class="p">,</span><span class="s1">&#39;y_modloss&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">assert</span> <span class="n">precursor_df</span><span class="o">.</span><span class="n">nAA</span><span class="o">.</span><span class="n">is_monotonic</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">precursor_mz</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="mf">545.233862</span><span class="p">,</span> <span class="mf">545.233862</span><span class="p">,</span> <span class="mf">1746.732265</span><span class="p">,</span> <span class="mf">1746.732265</span><span class="p">])</span>
<span class="n">ith_pep</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">frag_start</span><span class="p">,</span> <span class="n">frag_end</span> <span class="o">=</span> <span class="n">precursor_df</span><span class="p">[[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">,</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">frag_start</span><span class="p">:</span><span class="n">frag_end</span><span class="p">][</span><span class="s1">&#39;b_z1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
        <span class="p">[</span> <span class="mf">72.04439025</span><span class="p">,</span>  <span class="mf">129.06585397</span><span class="p">,</span>  <span class="mf">266.12476583</span><span class="p">,</span>  <span class="mf">369.13395079</span><span class="p">,</span>
        <span class="mf">498.17654388</span><span class="p">,</span>  <span class="mf">684.25585683</span><span class="p">,</span>  <span class="mf">812.31443434</span><span class="p">,</span>  <span class="mf">943.35491942</span><span class="p">]</span>
    <span class="p">)</span>
<span class="n">ith_pep</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">frag_start</span><span class="p">,</span> <span class="n">frag_end</span> <span class="o">=</span> <span class="n">precursor_df</span><span class="p">[[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">,</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">]</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">frag_start</span><span class="p">:</span><span class="n">frag_end</span><span class="p">][</span><span class="s1">&#39;b_z2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">precursor_df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sequence</th>
      <th>mods</th>
      <th>mod_sites</th>
      <th>nAA</th>
      <th>charge</th>
      <th>precursor_mz</th>
      <th>frag_start_idx</th>
      <th>frag_end_idx</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AGHCEWQMK</td>
      <td></td>
      <td></td>
      <td>9</td>
      <td>2</td>
      <td>545.233862</td>
      <td>0</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AGHCEWQMK</td>
      <td></td>
      <td></td>
      <td>9</td>
      <td>2</td>
      <td>545.233862</td>
      <td>8</td>
      <td>16</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AGHCEWQMKAADER</td>
      <td>Acetyl@Protein N-term;Carbamidomethyl@C;Oxidat...</td>
      <td>0;4;8</td>
      <td>14</td>
      <td>1</td>
      <td>1746.732265</td>
      <td>16</td>
      <td>29</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AGHCEWQMKAADER</td>
      <td>Acetyl@Protein N-term;Carbamidomethyl@C;Oxidat...</td>
      <td>0;4;8</td>
      <td>14</td>
      <td>1</td>
      <td>1746.732265</td>
      <td>29</td>
      <td>42</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test <code>get_sliced_fragment_dataframe()</code> and <code>update_sliced_fragment_dataframe()</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sliced_frag_df</span> <span class="o">=</span> <span class="n">get_sliced_fragment_dataframe</span><span class="p">(</span>
    <span class="n">fragment_mz_df</span><span class="p">,</span> 
    <span class="n">precursor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="mi">0</span><span class="p">,[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">,</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
        <span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],:</span>
    <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sliced_frag_df</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>
<span class="n">sliced_frag_df</span> <span class="o">=</span> <span class="n">get_sliced_fragment_dataframe</span><span class="p">(</span>
    <span class="n">fragment_mz_df</span><span class="p">,</span> 
    <span class="n">precursor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="mi">0</span><span class="p">,[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">,</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
        <span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],:</span>
    <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sliced_frag_df</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>

<span class="n">ith_pep</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">update_sliced_fragment_dataframe</span><span class="p">(</span>
    <span class="n">fragment_mz_df</span><span class="p">,</span> 
    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">nAA</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))),</span>
    <span class="p">[(</span><span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">],</span><span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">])]</span>
<span class="p">)</span>
<span class="n">sliced_frag_df</span> <span class="o">=</span> <span class="n">get_sliced_fragment_dataframe</span><span class="p">(</span>
    <span class="n">fragment_mz_df</span><span class="p">,</span> 
    <span class="n">precursor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">:</span><span class="n">ith_pep</span><span class="p">,[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">,</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">nAA</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))),</span> 
    <span class="n">sliced_frag_df</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>

<span class="n">ith_pep</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">update_sliced_fragment_dataframe</span><span class="p">(</span>
    <span class="n">fragment_mz_df</span><span class="p">,</span> 
    <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">nAA</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))),</span>
    <span class="p">[(</span><span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">],</span><span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">])],</span>
    <span class="n">charged_frag_types</span><span class="o">=</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>
<span class="n">sliced_frag_df</span> <span class="o">=</span> <span class="n">get_sliced_fragment_dataframe</span><span class="p">(</span>
    <span class="n">fragment_mz_df</span><span class="p">,</span> 
    <span class="n">precursor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">:</span><span class="n">ith_pep</span><span class="p">,[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">,</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">nAA</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))),</span> 
    <span class="n">sliced_frag_df</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test <a href="/alphabase/fragment.html#create_fragment_mz_dataframe"><code>create_fragment_mz_dataframe</code></a></p>
<p>If nAA column is not sorted, <a href="/alphabase/fragment.html#create_fragment_mz_dataframe"><code>create_fragment_mz_dataframe</code></a> also works. But it would be much slower for large peptide sets.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">repeat</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">peptides</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AGHCEWQMKAADER&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">mods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Acetyl@Protein N-term;Carbamidomethyl@C;Oxidation@M&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0;4;8&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">peptides</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;AGHCEWQMK&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">mods</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">sites</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>

<span class="n">precursor_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">peptides</span><span class="p">,</span>
    <span class="s1">&#39;mods&#39;</span><span class="p">:</span> <span class="n">mods</span><span class="p">,</span>
    <span class="s1">&#39;mod_sites&#39;</span><span class="p">:</span> <span class="n">sites</span>
<span class="p">})</span>
<span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;nAA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
<span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">precursor_df</span><span class="o">.</span><span class="n">nAA</span><span class="o">.</span><span class="n">is_monotonic_increasing</span>
<span class="n">fragment_mz_df</span> <span class="o">=</span> <span class="n">create_fragment_mz_dataframe_by_sort_precursor</span><span class="p">(</span>
    <span class="n">precursor_df</span><span class="p">,</span>
    <span class="n">get_charged_frag_types</span><span class="p">([</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;b_modloss&#39;</span><span class="p">,</span><span class="s1">&#39;y_modloss&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">precursor_df</span> <span class="o">=</span> <span class="n">precursor_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;nAA&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fragment_mz_df1</span> <span class="o">=</span> <span class="n">create_fragment_mz_dataframe</span><span class="p">(</span>
    <span class="n">precursor_df</span><span class="p">,</span>
    <span class="n">get_charged_frag_types</span><span class="p">([</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;b_modloss&#39;</span><span class="p">,</span><span class="s1">&#39;y_modloss&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">reference_fragment_df</span><span class="o">=</span><span class="n">fragment_mz_df</span>
<span class="p">)</span>
<span class="n">ith_pep</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">frag_start</span><span class="p">,</span> <span class="n">frag_end</span> <span class="o">=</span> <span class="n">precursor_df</span><span class="p">[[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">,</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fragment_mz_df1</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">frag_start</span><span class="p">:</span><span class="n">frag_end</span><span class="p">][</span><span class="s1">&#39;b_z1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
        <span class="p">[</span> <span class="mf">72.04439025</span><span class="p">,</span>  <span class="mf">129.06585397</span><span class="p">,</span>  <span class="mf">266.12476583</span><span class="p">,</span>  <span class="mf">369.13395079</span><span class="p">,</span>
        <span class="mf">498.17654388</span><span class="p">,</span>  <span class="mf">684.25585683</span><span class="p">,</span>  <span class="mf">812.31443434</span><span class="p">,</span>  <span class="mf">943.35491942</span><span class="p">]</span>
    <span class="p">)</span>
<span class="n">ith_pep</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">frag_start</span><span class="p">,</span> <span class="n">frag_end</span> <span class="o">=</span> <span class="n">precursor_df</span><span class="p">[[</span><span class="s1">&#39;frag_start_idx&#39;</span><span class="p">,</span><span class="s1">&#39;frag_end_idx&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ith_pep</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">frag_start</span><span class="p">:</span><span class="n">frag_end</span><span class="p">][</span><span class="s1">&#39;b_z2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
        <span class="p">[</span> <span class="mf">57.5311157</span> <span class="p">,</span>  <span class="mf">86.04184756</span><span class="p">,</span> <span class="mf">154.57130349</span><span class="p">,</span> <span class="mf">234.58662783</span><span class="p">,</span>
            <span class="mf">299.10792438</span><span class="p">,</span> <span class="mf">392.14758085</span><span class="p">,</span> <span class="mf">456.1768696</span> <span class="p">,</span> <span class="mf">529.69456946</span><span class="p">,</span>
            <span class="mf">593.74205097</span><span class="p">,</span> <span class="mf">629.26060786</span><span class="p">,</span> <span class="mf">664.77916475</span><span class="p">,</span> <span class="mf">722.29263626</span><span class="p">,</span>
            <span class="mf">786.81393281</span><span class="p">]</span>
    <span class="p">)</span>
<span class="n">precursor_df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sequence</th>
      <th>mods</th>
      <th>mod_sites</th>
      <th>nAA</th>
      <th>charge</th>
      <th>frag_start_idx</th>
      <th>frag_end_idx</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>AGHCEWQMKAADER</td>
      <td>Acetyl@Protein N-term;Carbamidomethyl@C;Oxidat...</td>
      <td>0;4;8</td>
      <td>14</td>
      <td>2</td>
      <td>16</td>
      <td>29</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AGHCEWQMKAADER</td>
      <td>Acetyl@Protein N-term;Carbamidomethyl@C;Oxidat...</td>
      <td>0;4;8</td>
      <td>14</td>
      <td>2</td>
      <td>29</td>
      <td>42</td>
    </tr>
    <tr>
      <th>0</th>
      <td>AGHCEWQMK</td>
      <td></td>
      <td></td>
      <td>9</td>
      <td>2</td>
      <td>0</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AGHCEWQMK</td>
      <td></td>
      <td></td>
      <td>9</td>
      <td>2</td>
      <td>8</td>
      <td>16</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_reference_frag_df</span> <span class="o">=</span> <span class="n">fragment_mz_df</span>
<span class="n">fragment_mz_df</span> <span class="o">=</span> <span class="n">create_fragment_mz_dataframe</span><span class="p">(</span>
    <span class="n">precursor_df</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;b_z1&#39;</span><span class="p">,</span><span class="s1">&#39;y_z1&#39;</span><span class="p">],</span>
    <span class="n">reference_fragment_df</span><span class="o">=</span><span class="n">_reference_frag_df</span>
<span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">_reference_frag_df</span><span class="p">[</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Test-mod-deltas">Test mod deltas<a class="anchor-link" href="#Test-mod-deltas"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">peptides</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AGHCEWQMK&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">mods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Acetyl@Protein N-term;Carbamidomethyl@C;Oxidation@M&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0;4;8&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">peptides</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;AGHCEWQMK&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">mods</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;Acetyl@Protein N-term;Carbamidomethyl@C;Oxidation@M&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>
<span class="n">sites</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;0;4;8&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">repeat</span>

<span class="n">precursor_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">peptides</span><span class="p">,</span>
    <span class="s1">&#39;mods&#39;</span><span class="p">:</span> <span class="n">mods</span><span class="p">,</span>
    <span class="s1">&#39;mod_sites&#39;</span><span class="p">:</span> <span class="n">sites</span>
<span class="p">})</span>
<span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;nAA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
<span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">mod_deltas</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">precursor_df</span><span class="p">)</span>
<span class="n">mod_delta_sites</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">precursor_df</span><span class="p">)</span>
<span class="n">mod_deltas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mod_delta_sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;100;200&#39;</span><span class="p">,</span><span class="s1">&#39;0;-1&#39;</span>
<span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;mod_deltas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_deltas</span>
<span class="n">precursor_df</span><span class="p">[</span><span class="s1">&#39;mod_delta_sites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_delta_sites</span>
<span class="n">update_precursor_mz</span><span class="p">(</span><span class="n">precursor_df</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">precursor_mz</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="mf">752.747333</span><span class="p">,</span> <span class="mf">602.747333</span><span class="p">])</span>
<span class="n">fragment_mz_df</span> <span class="o">=</span> <span class="n">create_fragment_mz_dataframe</span><span class="p">(</span><span class="n">precursor_df</span><span class="p">,</span> <span class="n">charged_frag_types</span><span class="o">=</span><span class="n">fragment_mz_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="p">[</span><span class="s1">&#39;y_z1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">frag_start_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">frag_end_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
    <span class="p">[</span><span class="mf">1291.43971168</span><span class="p">,</span> <span class="mf">1234.41824796</span><span class="p">,</span> <span class="mf">1097.3593361</span> <span class="p">,</span>  <span class="mf">937.32868742</span><span class="p">,</span>
        <span class="mf">808.28609433</span><span class="p">,</span>  <span class="mf">622.20678138</span><span class="p">,</span>  <span class="mf">494.14820387</span><span class="p">,</span>  <span class="mf">347.11280417</span><span class="p">]</span>
<span class="p">),</span>  <span class="sa">f</span><span class="s1">&#39;200 Da must be added to all y-ions&#39;</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fragment_mz_df</span><span class="p">[</span><span class="s1">&#39;b_z1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">frag_start_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">frag_end_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
    <span class="p">[</span><span class="mf">214.05495494</span><span class="p">,</span>  <span class="mf">271.07641866</span><span class="p">,</span>  <span class="mf">408.13533052</span><span class="p">,</span>  <span class="mf">568.1659792</span> <span class="p">,</span>
        <span class="mf">697.20857228</span><span class="p">,</span>  <span class="mf">883.28788524</span><span class="p">,</span> <span class="mf">1011.34646274</span><span class="p">,</span> <span class="mf">1158.38186245</span><span class="p">]</span>
<span class="p">),</span>  <span class="sa">f</span><span class="s1">&#39;100 Da must be added to all b-ions&#39;</span>
<span class="n">precursor_df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sequence</th>
      <th>mods</th>
      <th>mod_sites</th>
      <th>nAA</th>
      <th>charge</th>
      <th>mod_deltas</th>
      <th>mod_delta_sites</th>
      <th>precursor_mz</th>
      <th>frag_start_idx</th>
      <th>frag_end_idx</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AGHCEWQMK</td>
      <td>Acetyl@Protein N-term;Carbamidomethyl@C;Oxidat...</td>
      <td>0;4;8</td>
      <td>9</td>
      <td>2</td>
      <td>100;200</td>
      <td>0;-1</td>
      <td>752.747333</td>
      <td>0</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AGHCEWQMK</td>
      <td>Acetyl@Protein N-term;Carbamidomethyl@C;Oxidat...</td>
      <td>0;4;8</td>
      <td>9</td>
      <td>2</td>
      <td></td>
      <td></td>
      <td>602.747333</td>
      <td>8</td>
      <td>16</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

